@using ProjetV3R_Employe.Data.Models
@inject EmployeService EmployeService

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color: red;">@errorMessage</p>
}
@if (!string.IsNullOrEmpty(successMessage))
{
    <p style="color: green;">@successMessage</p>
}

<EditForm Model="nouvelEmploye" OnValidSubmit="AjouterEmploye">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group">
        <label>Email</label>
        <InputText class="form-control" @bind-Value="nouvelEmploye.Email" />
        <ValidationMessage For="@(() => nouvelEmploye.Email)" />
    </div>
    <div class="form-group">
        <label>Rôle</label>
        <InputSelect class="form-control" @bind-Value="nouvelEmploye.Role">
            @if (roles != null && roles.Any())
            {
                @foreach (var role in roles)
                {
                    <option value="@role.IdRole">@role.NomRole</option>
                }
            }
        </InputSelect>
    </div>

    <button type="submit" class="btn btn-primary">Enregistrer</button>
</EditForm>

@code {
    [Parameter]
    public EventCallback OnEmployeAjoute { get; set; }

    private ProjetV3R_Employe.Data.Models.User nouvelEmploye = new ProjetV3R_Employe.Data.Models.User();
    private List<Role> roles = new List<Role>();
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        await ChargerRoles();
    }

    private async Task ChargerRoles()
    {
        try
        {
            roles = await EmployeService.ObtenirRolesAsync();
        }
        catch (Exception ex)
        {
            errorMessage = "Une erreur est survenue lors du chargement des rôles.";
            Console.Error.WriteLine($"Erreur dans CompAjoutEmploye - ChargerRoles: {ex.Message}");
        }
    }

    private async Task AjouterEmploye()
    {
        try
        {
            errorMessage = null;
            successMessage = null;

            // Si les validations de Blazor passent, tente d'ajouter l'employé
            await EmployeService.AjouterEmployeAsync(nouvelEmploye);
            successMessage = "L'employé a été ajouté avec succès.";
            await OnEmployeAjoute.InvokeAsync();
        }
        catch (Exception ex)
        {
            errorMessage = "Une erreur est survenue lors de l'ajout de l'employé. Veuillez réessayer.";
            Console.Error.WriteLine($"Erreur dans CompAjoutEmploye: {ex.Message}");
        }
    }
}
