@using ProjetV3R_Employe.Data.Models
@inject EmployeService EmployeService

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color: red;">@errorMessage</p>
}

<h3>Liste des Employés</h3>

<table class="table">
    <thead>
        <tr>
            <th>Email</th>
            <th>Rôle</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var employe in employes)
        {
            <tr>
                <td>@employe.Email</td>
                <td>@employe.Role</td>
                <td>
                    <button @onclick="() => OnModifierEmploye.InvokeAsync(employe)" class="btn btn-warning">Modifier</button>
                    <button @onclick="() => SupprimerEmploye(employe.Id)" class="btn btn-danger">Supprimer</button>
                </td>
            </tr>
        }
    </tbody>
</table>

@code {
    [Parameter]
    public EventCallback<User> OnModifierEmploye { get; set; }

    private List<User> employes = new List<User>();
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await ChargerEmployes();
    }

    public async Task RechargerAsync()
    {
        await ChargerEmployes();
    }

    private async Task ChargerEmployes()
    {
        try
        {
            employes = await EmployeService.ObtenirEmployesAsync();
        }
        catch (Exception ex)
        {
            errorMessage = "Une erreur est survenue lors du chargement des employés. Veuillez réessayer.";
            Console.Error.WriteLine($"Erreur dans CompListeEmploye - ChargerEmployes: {ex.Message}");
        }
    }

    private async Task SupprimerEmploye(int id)
    {
        try
        {
            await EmployeService.SupprimerEmployeAsync(id);
            await ChargerEmployes(); // Rafraîchir la liste après suppression
        }
        catch (Exception ex)
        {
            errorMessage = "Une erreur est survenue lors de la suppression de l'employé. Veuillez réessayer.";
            Console.Error.WriteLine($"Erreur dans CompListeEmploye - SupprimerEmploye: {ex.Message}");
        }
    }
}
