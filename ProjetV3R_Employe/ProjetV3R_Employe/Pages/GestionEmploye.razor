@page "/gestion-employes"
@using ProjetV3R_Employe.Data.Models
@using ProjetV3R_Employe.Shared.ComposantsGestionEmploye
@inject EmployeService EmployeService
@inject NavigationManager Navigation
<<<<<<< HEAD


@*@inject AuthenticationStateProvider AuthenticationStateProvider
=======
@inject AuthenticationStateProvider AuthenticationStateProvider
>>>>>>> parent of 3040664 (c kk mdr)
@using System.Security.Claims
@attribute [Authorize(Roles = "Administrateur")]
@inject AuthenticationStateProvider AuthStateProvider
@inject CustomAuthenticationStateProvider CustomAuthProvider


<<<<<<< HEAD
@*<AuthorizeView Roles="Administrateur">*@
=======
<AuthorizeView Roles="Administrateur">
    <h3>Gestion des Employés</h3>
    <p>Page accessible uniquement aux administrateurs.</p>
>>>>>>> parent of 3040664 (c kk mdr)

    <h3>Gestion des employés</h3>

    <button OnEmployeModifie="RafraichirListe" @onclick="AfficherFormulaireAjout">Ajouter un employé</button>

<<<<<<< HEAD
    @if (afficherFormulaireAjout)
=======
    @if (formulaireVisible)
>>>>>>> parent of 3040664 (c kk mdr)
    {
        <CompAjoutEmploye OnEmployeAjoute="FermerFormulaireAjout" />
    }

<<<<<<< HEAD
    <CompListeEmploye OnModifier="AfficherFormulaireModification" OnSupprimer="AfficherPopupSuppression" />

    @if (employeSelectionnePourModification != null)
    {
        <CompModifEmploye Employe="employeSelectionnePourModification" OnModificationTerminee="ReinitialiserFormulaires" />
    }

    @if (afficherPopupSuppression && employeSelectionnePourSuppression != null)
    {
        <div class="popup-suppression">
            <p>Voulez-vous vraiment supprimer l'employé : @employeSelectionnePourSuppression.Email ?</p>
            <button OnEmployeModifie="RafraichirListe" @onclick="ConfirmerSuppression">Confirmer</button>
            <button OnEmployeModifie="RafraichirListe" @onclick="AnnulerSuppression">Annuler</button>
        </div>
    }





@*</AuthorizeView>*@

@code {
=======
    <CompListeEmploye @ref="listeEmployes" OnModifierEmploye="EditerEmploye" />
</AuthorizeView>

@code {
    private bool formulaireVisible;
    private User employeSelectionne = new User();
    private CompListeEmploye? listeEmployes;

>>>>>>> parent of 3040664 (c kk mdr)
    private bool isAuthorized = false;
    private string? role;
    private string? email;

<<<<<<< HEAD
    private bool afficherFormulaireAjout = false;
    private User employeSelectionnePourModification;
    private User employeSelectionnePourSuppression;
    private bool afficherPopupSuppression = false;
    private CompListeEmploye listeEmploye;

    //protected override async Task OnInitializedAsync()
    //{
    //    var authState = await CustomAuthProvider.GetAuthenticationStateAsync();
    //    var user = authState.User;
=======
    protected override async Task OnInitializedAsync()
    {
        var authState = await CustomAuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;
>>>>>>> parent of 3040664 (c kk mdr)

        Console.WriteLine($"[GESTION EMPLOYE]Utilisateur authentifié : {user.Identity?.Name}, Rôle : {role}");

        user = authState.User;

        foreach (var claim in user.Claims)
        {
            Console.WriteLine($"Claim: {claim.Type}, Value: {claim.Value}");
        }

        if (user.Identity?.IsAuthenticated == true)
        {
            role = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value;
            email = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Name)?.Value;

            if (role == "Administrateur" || role == "Tenant-Admin")
            {
                isAuthorized = true;
            }
            else
            {
                Navigation.NavigateTo("/access-denied", forceLoad: true);
            }
        }
        else
        {
            Navigation.NavigateTo("/", forceLoad: true);
        }
    }


    private void AfficherFormulaireAjout()
    {
<<<<<<< HEAD
        afficherFormulaireAjout = !afficherFormulaireAjout;
        employeSelectionnePourModification = null;
        employeSelectionnePourSuppression = null;
=======
        employeSelectionne = new User(); // Réinitialiser pour un ajout
        formulaireVisible = true;
>>>>>>> parent of 3040664 (c kk mdr)
    }

    // Méthode appelée lorsque l'ajout est terminé
    private void FermerFormulaireAjout()
    {
<<<<<<< HEAD
        afficherFormulaireAjout = false;
=======
        employeSelectionne = employe; // Charger l'employé existant pour édition
        formulaireVisible = true;
>>>>>>> parent of 3040664 (c kk mdr)
    }

    // Méthode pour afficher le formulaire de modification
    private void AfficherFormulaireModification(User employe)
    {
<<<<<<< HEAD
        employeSelectionnePourModification = employe;
        employeSelectionnePourSuppression = null;
        afficherFormulaireAjout = false;
    }

    // Méthode pour afficher la popup de suppression
    private void AfficherPopupSuppression(User employe)
    {
        employeSelectionnePourSuppression = employe;
        afficherPopupSuppression = true;
    }

    // Confirme la suppression de l'employé
    private async Task ConfirmerSuppression()
    {
        if (employeSelectionnePourSuppression != null)
=======
        formulaireVisible = false;
        if (listeEmployes != null)
>>>>>>> parent of 3040664 (c kk mdr)
        {
            await EmployeService.SupprimerEmployeAsync(employeSelectionnePourSuppression.Id);
        }
        ReinitialiserFormulaires();
    }
<<<<<<< HEAD

    // Annule la suppression
    private void AnnulerSuppression()
    {
        afficherPopupSuppression = false;
        employeSelectionnePourSuppression = null;
    }

    // Réinitialise tous les formulaires
    private void ReinitialiserFormulaires()
    {
        employeSelectionnePourModification = null;
        employeSelectionnePourSuppression = null;
        afficherFormulaireAjout = false;
        afficherPopupSuppression = false;
    }

    private void RafraichirListe()
    {
        employeSelectionnePourModification = null;
        StateHasChanged();
    }

}
=======
}
>>>>>>> parent of 3040664 (c kk mdr)
