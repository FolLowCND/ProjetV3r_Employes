@page "/"
@using Microsoft.EntityFrameworkCore
@using ProjetV3R_Employe.Data.Models


@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation


<h3>Connexion Fournisseur</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color: red;">@errorMessage</p>
}

<EditForm Model="userModel" OnValidSubmit="CheckUserEmail">
    
    <div class="form-group">
        <label for="emailInput">Email</label>
        <InputText id="emailInput" class="form-control" @bind-Value="userModel.Email" />
        <DataAnnotationsValidator />
        <ValidationMessage For="@(() => userModel.Email)" />
    </div>

    <button type="submit" class="btn btn-primary">Connexion</button>
</EditForm>

@code {

    @using System.ComponentModel.DataAnnotations;

    public class UserModel
    {
        [Required(ErrorMessage = "L'email est obligatoire.")]
        [EmailAddress(ErrorMessage = "Veuillez entrer une adresse email valide.")]
        [RegularExpression(@"^[^@\s]+@[^@\s]+\.[^@\s]+$", ErrorMessage = "Veuillez entrer un email au format valide.")]
        public string Email { get; set; } = string.Empty;
    }


    private UserModel userModel = new UserModel();
    private string? errorMessage;

    private async Task CheckUserEmail()
    {
        try
        {
            // Vérifie si l'email existe dans la base de données
            var userExists = await DbContext.Users.AnyAsync(u => u.Email == userModel.Email);

            if (userExists)
            {
                // Redirige vers la page Gestion-fournisseurs si l'email existe
                Navigation.NavigateTo("/Gestion-fournisseurs");
            }
            else
            {
                // Affiche un message d'erreur si l'email n'existe pas
                errorMessage = "Nous ne parvenons pas à trouver votre compte. Veuillez réessayer.";
            }
        }
        catch (Exception ex)
        {
            // Gestion des erreurs, affichage d'un message d'erreur générique
            errorMessage = "Une erreur est survenue lors de la vérification. Veuillez réessayer plus tard.";
            Console.Error.WriteLine($"Erreur lors de la vérification de l'email : {ex.Message}");
        }
    }
}
